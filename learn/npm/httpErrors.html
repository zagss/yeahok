<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.66">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/images/logo.png"><title>1. http-errors | 你当像鸟飞往你的山</title><meta name="description" content="这是我的第一个 VuePress 站点">
    <link rel="preload" href="/yeahok/assets/style-77c93d53.css" as="style"><link rel="stylesheet" href="/yeahok/assets/style-77c93d53.css">
    <link rel="modulepreload" href="/yeahok/assets/app-03679ccd.js"><link rel="modulepreload" href="/yeahok/assets/httpErrors.html-c193037a.js"><link rel="modulepreload" href="/yeahok/assets/httpErrors.html-f9e48a6a.js"><link rel="prefetch" href="/yeahok/assets/index.html-0a856ab4.js" as="script"><link rel="prefetch" href="/yeahok/assets/collection.html-4f04ed55.js" as="script"><link rel="prefetch" href="/yeahok/assets/func.html-7f25f14a.js" as="script"><link rel="prefetch" href="/yeahok/assets/git.html-eca86812.js" as="script"><link rel="prefetch" href="/yeahok/assets/goview.html-5033cccd.js" as="script"><link rel="prefetch" href="/yeahok/assets/html.html-65de3cd3.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-92edef6f.js" as="script"><link rel="prefetch" href="/yeahok/assets/js.html-5c30a33c.js" as="script"><link rel="prefetch" href="/yeahok/assets/npm.html-4440708f.js" as="script"><link rel="prefetch" href="/yeahok/assets/project.html-a46e3ea8.js" as="script"><link rel="prefetch" href="/yeahok/assets/ts.html-987eab98.js" as="script"><link rel="prefetch" href="/yeahok/assets/upload.html-1251052b.js" as="script"><link rel="prefetch" href="/yeahok/assets/vue.html-44f3ff4d.js" as="script"><link rel="prefetch" href="/yeahok/assets/webpack.html-a1e4eab7.js" as="script"><link rel="prefetch" href="/yeahok/assets/work.html-6744da99.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-f909bb66.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-a98a7155.js" as="script"><link rel="prefetch" href="/yeahok/assets/array.html-1309b5bf.js" as="script"><link rel="prefetch" href="/yeahok/assets/controlFlow.html-d775a657.js" as="script"><link rel="prefetch" href="/yeahok/assets/dataType.html-39fe7fe8.js" as="script"><link rel="prefetch" href="/yeahok/assets/function.html-2ee7a526.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-91d9cff2.js" as="script"><link rel="prefetch" href="/yeahok/assets/learn.html-0014cc95.js" as="script"><link rel="prefetch" href="/yeahok/assets/map.html-6491db84.js" as="script"><link rel="prefetch" href="/yeahok/assets/operators.html-ae536fc7.js" as="script"><link rel="prefetch" href="/yeahok/assets/package.html-25dced3b.js" as="script"><link rel="prefetch" href="/yeahok/assets/pointer.html-8fe80e61.js" as="script"><link rel="prefetch" href="/yeahok/assets/slice.html-29e27334.js" as="script"><link rel="prefetch" href="/yeahok/assets/struct.html-53bdbaaa.js" as="script"><link rel="prefetch" href="/yeahok/assets/var.html-2d431683.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-726fa291.js" as="script"><link rel="prefetch" href="/yeahok/assets/promise.html-46d69467.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-9d7a719f.js" as="script"><link rel="prefetch" href="/yeahok/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-c26560c9.js" as="script"><link rel="prefetch" href="/yeahok/assets/collection.html-99c1a37c.js" as="script"><link rel="prefetch" href="/yeahok/assets/func.html-7870a5fd.js" as="script"><link rel="prefetch" href="/yeahok/assets/git.html-74f37723.js" as="script"><link rel="prefetch" href="/yeahok/assets/goview.html-40894cf2.js" as="script"><link rel="prefetch" href="/yeahok/assets/html.html-e48114d8.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-2ada4722.js" as="script"><link rel="prefetch" href="/yeahok/assets/js.html-fda0db12.js" as="script"><link rel="prefetch" href="/yeahok/assets/npm.html-72470ede.js" as="script"><link rel="prefetch" href="/yeahok/assets/project.html-2856af8f.js" as="script"><link rel="prefetch" href="/yeahok/assets/ts.html-461c3d67.js" as="script"><link rel="prefetch" href="/yeahok/assets/upload.html-1d3d7c96.js" as="script"><link rel="prefetch" href="/yeahok/assets/vue.html-24df0513.js" as="script"><link rel="prefetch" href="/yeahok/assets/webpack.html-741ebaac.js" as="script"><link rel="prefetch" href="/yeahok/assets/work.html-9c081dcd.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-e0dd6b6d.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-5c6bbb95.js" as="script"><link rel="prefetch" href="/yeahok/assets/array.html-ffdc9d5d.js" as="script"><link rel="prefetch" href="/yeahok/assets/controlFlow.html-e8c144d0.js" as="script"><link rel="prefetch" href="/yeahok/assets/dataType.html-b46634c5.js" as="script"><link rel="prefetch" href="/yeahok/assets/function.html-723b2627.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-63779673.js" as="script"><link rel="prefetch" href="/yeahok/assets/learn.html-0674b16c.js" as="script"><link rel="prefetch" href="/yeahok/assets/map.html-8c3dc112.js" as="script"><link rel="prefetch" href="/yeahok/assets/operators.html-8af8f051.js" as="script"><link rel="prefetch" href="/yeahok/assets/package.html-df52c18b.js" as="script"><link rel="prefetch" href="/yeahok/assets/pointer.html-412988a3.js" as="script"><link rel="prefetch" href="/yeahok/assets/slice.html-41c66b1f.js" as="script"><link rel="prefetch" href="/yeahok/assets/struct.html-31193b86.js" as="script"><link rel="prefetch" href="/yeahok/assets/var.html-1a413cb1.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-d24e3ce3.js" as="script"><link rel="prefetch" href="/yeahok/assets/promise.html-271ebcb6.js" as="script"><link rel="prefetch" href="/yeahok/assets/index.html-708347eb.js" as="script"><link rel="prefetch" href="/yeahok/assets/404.html-c8147ba1.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/yeahok/" class=""><img class="logo" src="/yeahok/images/logo.png" alt="你当像鸟飞往你的山"><span class="site-name can-hide">你当像鸟飞往你的山</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/yeahok/interview" class="" aria-label="温故知新"><!--[--><!--]--> 温故知新 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="学而不怠"><span class="title">学而不怠</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="学而不怠"><span class="title">学而不怠</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/yeahok/learn/go/" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/yeahok/learn/npm/" class="router-link-active" aria-label="每天一个 npm 包"><!--[--><!--]--> 每天一个 npm 包 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/yeahok/learn/js/" class="" aria-label="JS"><!--[--><!--]--> JS <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/yeahok/learn/cli/" class="" aria-label="从 0 构建自己的脚手架"><!--[--><!--]--> 从 0 构建自己的脚手架 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/yeahok/interview" class="" aria-label="温故知新"><!--[--><!--]--> 温故知新 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="学而不怠"><span class="title">学而不怠</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="学而不怠"><span class="title">学而不怠</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/yeahok/learn/go/" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/yeahok/learn/npm/" class="router-link-active" aria-label="每天一个 npm 包"><!--[--><!--]--> 每天一个 npm 包 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/yeahok/learn/js/" class="" aria-label="JS"><!--[--><!--]--> JS <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/yeahok/learn/cli/" class="" aria-label="从 0 构建自己的脚手架"><!--[--><!--]--> 从 0 构建自己的脚手架 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/yeahok/learn/npm/" class="router-link-active sidebar-item sidebar-heading" aria-label="每天一个 npm 包"><!--[--><!--]--> 每天一个 npm 包 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html" class="router-link-active router-link-exact-active router-link-active sidebar-item sidebar-heading active" aria-label="1. http-errors"><!--[--><!--]--> 1. http-errors <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="简介"><!--[--><!--]--> 简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#依赖" class="router-link-active router-link-exact-active sidebar-item" aria-label="依赖"><!--[--><!--]--> 依赖 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#depd" class="router-link-active router-link-exact-active sidebar-item" aria-label="depd"><!--[--><!--]--> depd <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#statuses" class="router-link-active router-link-exact-active sidebar-item" aria-label="statuses"><!--[--><!--]--> statuses <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#setprototypeof" class="router-link-active router-link-exact-active sidebar-item" aria-label="setprototypeof"><!--[--><!--]--> setprototypeof <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#inherits" class="router-link-active router-link-exact-active sidebar-item" aria-label="inherits"><!--[--><!--]--> inherits <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#toidentifier" class="router-link-active router-link-exact-active sidebar-item" aria-label="toIdentifier"><!--[--><!--]--> toIdentifier <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#http-errors-源码分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="http-errors 源码分析"><!--[--><!--]--> http-errors 源码分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/yeahok/learn/npm/httpErrors.html#相关资料" class="router-link-active router-link-exact-active sidebar-item" aria-label="相关资料"><!--[--><!--]--> 相关资料 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="_1-http-errors" tabindex="-1"><a class="header-anchor" href="#_1-http-errors" aria-hidden="true">#</a> 1. http-errors</h1><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><p><code>http-errors</code> 主要供 <code>express</code>、<code>koa</code> 等后端框架使用，用于便捷地创建 HTTP 异常状态。简单使用如下所示：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> createError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http-errors&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3001</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Example app listening at http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="依赖" tabindex="-1"><a class="header-anchor" href="#依赖" aria-hidden="true">#</a> 依赖</h2><p><code>http-errors</code> 的外部依赖包有 <code>depd</code>、<code>setprototypeof</code>、<code>statuses</code>、<code>inherits</code>、<code>toidentifier</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> deprecate <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;depd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&#39;http-errors&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> setPrototypeOf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;setprototypeof&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> statuses <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;statuses&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> inherits <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;inherits&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> toIdentifier <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;toidentifier&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="depd" tabindex="-1"><a class="header-anchor" href="#depd" aria-hidden="true">#</a> depd</h3><p><code>depd</code> 主要用于输出提示信息以及实现向后兼容操作，简单使用如下所示：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> deprecate <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;depd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&#39;LvLin-test&#39;</span><span class="token punctuation">)</span>
<span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token string">&#39;Hello, I am LvLin.&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 输出提示语</span>

<span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Hello world!&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 实际运行了 sayHello，并输出了相关提示</span>
<span class="token keyword">const</span> sayHi <span class="token operator">=</span> deprecate<span class="token punctuation">.</span><span class="token function">function</span><span class="token punctuation">(</span>sayHello<span class="token punctuation">,</span> <span class="token string">&#39;sayHi; use &quot;sayHello&quot; instead&#39;</span><span class="token punctuation">)</span>
<span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>效果如下图所示：</p><p><img src="/yeahok/assets/image-7a941d87.png" alt="Alt text"></p><h3 id="statuses" tabindex="-1"><a class="header-anchor" href="#statuses" aria-hidden="true">#</a> statuses</h3><p>statuses 是一个处理 HTTP 状态码的工具库。需要注意的是 http-errors 使用的 statuses 低于 2.0 版本，因为在 2.x 版本中部分 api 已经不再支持。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token string-property property">&quot;statuses&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt;= 1.5.0 &lt; 2&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>statuses 的简单使用如下所示：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>status<span class="token punctuation">[</span><span class="token number">404</span><span class="token punctuation">]</span> <span class="token comment">// =&gt; &#39;Not Found&#39;</span>
status<span class="token punctuation">[</span><span class="token string">&#39;Not Found&#39;</span><span class="token punctuation">]</span> <span class="token comment">// =&gt; 404</span>
status<span class="token punctuation">.</span>codes <span class="token comment">// 获取所有状态码</span>
<span class="token comment">// [</span>
<span class="token comment">//     100, 101, 102, 103, 200, 201, 202, 203, 204,</span>
<span class="token comment">//     205, 206, 207, 208, 226, 300, 301, 302, 303,</span>
<span class="token comment">//     304, 305, 306, 307, 308, 400, 401, 402, 403,</span>
<span class="token comment">//     404, 405, 406, 407, 408, 409, 410, 411, 412,</span>
<span class="token comment">//     413, 414, 415, 416, 417, 418, 421, 422, 423,</span>
<span class="token comment">//     424, 425, 426, 428, 429, 431, 451, 500, 501,</span>
<span class="token comment">//     502, 503, 504, 505, 506, 507, 508, 509, 510,</span>
<span class="token comment">//     511</span>
<span class="token comment">// ]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>statuses 的源码可以简单看一下，相关解释见注释：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token string">&#39;use strict&#39;</span>

<span class="token comment">// 引入状态码映射表，结构如下</span>
<span class="token comment">// {</span>
<span class="token comment">//   &quot;100&quot;: &quot;Continue&quot;,</span>
<span class="token comment">//   &quot;101&quot;: &quot;Switching Protocols&quot;,</span>
<span class="token comment">//   &quot;102&quot;: &quot;Processing&quot;,</span>
<span class="token comment">//   &quot;103&quot;: &quot;Early Hints&quot;,</span>
<span class="token comment">//   ...</span>
<span class="token comment">// }</span>
<span class="token keyword">var</span> codes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./codes.json&#39;</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> status

<span class="token comment">// status.STATUS_CODES 保存了所有状态码的原因短语映射</span>
status<span class="token punctuation">.</span><span class="token constant">STATUS_CODES</span> <span class="token operator">=</span> codes

<span class="token comment">// status.codes 保存了所有的状态码</span>
status<span class="token punctuation">.</span>codes <span class="token operator">=</span> <span class="token function">populateStatusesMap</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> codes<span class="token punctuation">)</span>

<span class="token comment">// 与重定向相关的状态码</span>
status<span class="token punctuation">.</span>redirect <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">300</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">301</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">302</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">303</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">305</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">307</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">308</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 响应报文没有 body 的状态码</span>
status<span class="token punctuation">.</span>empty <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">204</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">205</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">304</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 暂时无法处理请求，需要重试请求的状态码</span>
status<span class="token punctuation">.</span>retry <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">502</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">503</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token number">504</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将状态码跟原因短语绑定到 statuses 上</span>
<span class="token keyword">function</span> <span class="token function">populateStatusesMap</span><span class="token punctuation">(</span><span class="token parameter">statuses<span class="token punctuation">,</span> codes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>codes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">forEachCode</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> codes<span class="token punctuation">[</span>code<span class="token punctuation">]</span>
    <span class="token keyword">var</span> status <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>

    <span class="token comment">// 状态码跟原因短语绑定到 statuses上</span>
    <span class="token comment">// 全小写的原因短语也考虑</span>
    statuses<span class="token punctuation">[</span>status<span class="token punctuation">]</span> <span class="token operator">=</span> message
    statuses<span class="token punctuation">[</span>message<span class="token punctuation">]</span> <span class="token operator">=</span> status
    statuses<span class="token punctuation">[</span>message<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> status

    <span class="token comment">// 将状态码保存，为了返回给 status.codes</span>
    arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> arr
<span class="token punctuation">}</span>

<span class="token comment">// 接受一个code，只能是数字或者字符串</span>
<span class="token comment">// 如果是数字：如果是支持的状态码，返回该数字，否则抛出异常</span>
<span class="token comment">// 如果字符串：1、尝试转成数字，如果非 NaN，判断是否是支持的状态码，返回该数字或者抛出异常</span>
<span class="token comment">//           2、当成原因短语处理，判断是否有符合的原因短语，返回相应的状态码或者抛出异常</span>
<span class="token keyword">function</span> <span class="token function">status</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> code <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;invalid status code: &#39;</span> <span class="token operator">+</span> code<span class="token punctuation">)</span>
    <span class="token keyword">return</span> code
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> code <span class="token operator">!==</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#39;code must be a number or string&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// &#39;403&#39;</span>
  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;invalid status code: &#39;</span> <span class="token operator">+</span> n<span class="token punctuation">)</span>
    <span class="token keyword">return</span> n
  <span class="token punctuation">}</span>

  n <span class="token operator">=</span> status<span class="token punctuation">[</span>code<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;invalid status message: &quot;&#39;</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">&#39;&quot;&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> n
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="setprototypeof" tabindex="-1"><a class="header-anchor" href="#setprototypeof" aria-hidden="true">#</a> setprototypeof</h3><p>setprototypeof 是一个 Object.setPrototypeOf 的垫片库，跨平台，兼容到 IE8。</p><p>看一下源码实现：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token string">&#39;use strict&#39;</span>
<span class="token comment">/* eslint no-proto: 0 */</span>
<span class="token comment">// 优先使用 Object.setPrototypeOf</span>
<span class="token comment">// 判断使用 __proto__ 能不能改变原型链，如果可以就用 setProtoOf</span>
<span class="token comment">// 如果不行就用 mixinProperties</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span>
  Object<span class="token punctuation">.</span>setPrototypeOf <span class="token operator">||</span>
  <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">__proto__</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span> <span class="token operator">?</span> setProtoOf <span class="token operator">:</span> mixinProperties<span class="token punctuation">)</span>

<span class="token comment">// 可以通过 __proto__ 修改原型链，直接修改</span>
<span class="token keyword">function</span> <span class="token function">setProtoOf</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> proto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> proto
  <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>

<span class="token comment">// 无法通过 __proto__ 修改原型链</span>
<span class="token keyword">function</span> <span class="token function">mixinProperties</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> proto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> prop <span class="token keyword">in</span> proto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 找出非本对象已有的属性，绑定到对象上</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> proto<span class="token punctuation">[</span>prop<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="inherits" tabindex="-1"><a class="header-anchor" href="#inherits" aria-hidden="true">#</a> inherits</h3><p>inherits 用于实现对象的原型继承，简单使用如下所示：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;base&#39;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">=</span> <span class="token number">1991</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Sub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;sub&#39;</span>
<span class="token punctuation">}</span>
<span class="token function">inherits</span><span class="token punctuation">(</span>Sub<span class="token punctuation">,</span> Base<span class="token punctuation">)</span>

<span class="token keyword">let</span> objSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sub</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
objSub<span class="token punctuation">.</span>base <span class="token comment">// 1991</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看一下源码：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// inherits.js</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是 node 环境，用 util.inherits</span>
  <span class="token keyword">var</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;util&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">/* istanbul ignore next */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> util<span class="token punctuation">.</span>inherits <span class="token operator">!==</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">&#39;&#39;</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> util<span class="token punctuation">.</span>inherits
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是浏览器环境就使用 inherits_browser.js</span>
  <span class="token comment">/* istanbul ignore next */</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./inherits_browser.js&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// inherits_browser.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Object<span class="token punctuation">.</span>create <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果支持 Object.create，使用 object.create 实现寄生组合式继承</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">inherits</span><span class="token punctuation">(</span><span class="token parameter">ctor<span class="token punctuation">,</span> superCtor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>superCtor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctor<span class="token punctuation">.</span>super_ <span class="token operator">=</span> superCtor
      ctor<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>superCtor<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">constructor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">value</span><span class="token operator">:</span> ctor<span class="token punctuation">,</span>
          <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 利用空的构造函数实现寄生组合式继承</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">inherits</span><span class="token punctuation">(</span><span class="token parameter">ctor<span class="token punctuation">,</span> superCtor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>superCtor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctor<span class="token punctuation">.</span>super_ <span class="token operator">=</span> superCtor
      <span class="token keyword">var</span> <span class="token function-variable function">TempCtor</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token class-name">TempCtor</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> superCtor<span class="token punctuation">.</span>prototype
      ctor<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TempCtor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      ctor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> ctor
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="toidentifier" tabindex="-1"><a class="header-anchor" href="#toidentifier" aria-hidden="true">#</a> toIdentifier</h3><p>toIdentifier 用于将字符串转成符合规范的变量名，源码及解释如下所示：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">toIdentifier</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> str
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39; &#39;</span><span class="token punctuation">)</span> <span class="token comment">// 按照空格将字符串分割成数组</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 各单词首字母大写</span>
      <span class="token keyword">return</span> token<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> token<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 所有单词重新拼接在一起</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^ _0-9a-z]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 去掉特殊字符</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="http-errors-源码分析" tabindex="-1"><a class="header-anchor" href="#http-errors-源码分析" aria-hidden="true">#</a> http-errors 源码分析</h2><p>先从几个简单的工具函数看起。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 将状态码根据开头数字进行归类，比如 401、402 的 codeClass 为 400</span>
<span class="token keyword">function</span> <span class="token function">codeClass</span><span class="token punctuation">(</span><span class="token parameter">status</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;00&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从名称标符获取类名，以 Error 结尾，</span>
<span class="token keyword">function</span> <span class="token function">toClassName</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">&#39;Error&#39;</span> <span class="token operator">?</span> name <span class="token operator">+</span> <span class="token string">&#39;Error&#39;</span> <span class="token operator">:</span> name
<span class="token punctuation">}</span>

<span class="token comment">// 修改函数的名称</span>
<span class="token keyword">function</span> <span class="token function">nameFunc</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> desc <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>desc <span class="token operator">&amp;&amp;</span> desc<span class="token punctuation">.</span>configurable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果可修改，通过 Object.defineProperty 修改函数名称</span>
    desc<span class="token punctuation">.</span>value <span class="token operator">=</span> name
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> desc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>create.HttpError 是用于继承的抽象类，不能直接调用。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>HttpError <span class="token operator">=</span> <span class="token function">createHttpErrorConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 生成一个抽象基类</span>

<span class="token keyword">function</span> <span class="token function">createHttpErrorConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这是一个抽象类，不能直接调用，只是用于继承</span>
  <span class="token comment">// 如果直接调用，抛出异常</span>
  <span class="token keyword">function</span> <span class="token function">HttpError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#39;cannot construct abstract class&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">inherits</span><span class="token punctuation">(</span>HttpError<span class="token punctuation">,</span> Error<span class="token punctuation">)</span>
  <span class="token keyword">return</span> HttpError
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>createError.isHttpError 用于判断实例是否是 HttpError 类型。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>isHttpError <span class="token operator">=</span> <span class="token function">createIsHttpErrorFunction</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>HttpError<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createIsHttpErrorFunction</span><span class="token punctuation">(</span><span class="token parameter">HttpError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">isHttpError</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>val <span class="token operator">||</span> <span class="token keyword">typeof</span> val <span class="token operator">!==</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果继承自 HttpError，返回 true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token keyword">instanceof</span> <span class="token class-name">HttpError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通过 createError() 创建的自定义错误类型条件</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      val <span class="token keyword">instanceof</span> <span class="token class-name">Error</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> val<span class="token punctuation">.</span>expose <span class="token operator">===</span> <span class="token string">&#39;boolean&#39;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> val<span class="token punctuation">.</span>statusCode <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span> <span class="token operator">&amp;&amp;</span>
      val<span class="token punctuation">.</span>status <span class="token operator">===</span> val<span class="token punctuation">.</span>statusCode
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>初始化时，创建各个状态码异常类的构造函数，并绑定到 createError 上。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 将各类错误的 constructor 绑定到 createError 上，方便调用，比如 new createError.NotFound()</span>
<span class="token function">populateConstructorExports</span><span class="token punctuation">(</span>
  module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>
  statuses<span class="token punctuation">.</span>codes<span class="token punctuation">,</span>
  module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>HttpError
<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">populateConstructorExports</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> codes<span class="token punctuation">,</span> HttpError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  codes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">forEachCode</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> CodeError
    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token function">toIdentifier</span><span class="token punctuation">(</span>statuses<span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">codeClass</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">400</span><span class="token operator">:</span> <span class="token comment">// 4xx 状态码，提供客户端异常类的构造函数</span>
        CodeError <span class="token operator">=</span> <span class="token function">createClientErrorConstructor</span><span class="token punctuation">(</span>HttpError<span class="token punctuation">,</span> name<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token number">500</span><span class="token operator">:</span> <span class="token comment">// 5xx 状态码，提供服务端异常类的构造函数</span>
        CodeError <span class="token operator">=</span> <span class="token function">createServerErrorConstructor</span><span class="token punctuation">(</span>HttpError<span class="token punctuation">,</span> name<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>CodeError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// createError[404] === createError.NotFound</span>
      <span class="token comment">// 相应的 code 和 name 对应同一个构造函数</span>
      exports<span class="token punctuation">[</span>code<span class="token punctuation">]</span> <span class="token operator">=</span> CodeError
      exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> CodeError
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 兼容旧版本的 I&#39;mateapot</span>
  exports<span class="token punctuation">[</span><span class="token string">&quot;I&#39;mateapot&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> deprecate<span class="token punctuation">.</span><span class="token function">function</span><span class="token punctuation">(</span>
    exports<span class="token punctuation">.</span>ImATeapot<span class="token punctuation">,</span>
    <span class="token string">&#39;&quot;I\&#39;mateapot&quot;; use &quot;ImATeapot&quot; instead&#39;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再来看看客户端异常类和服务端异常类的构造函数是怎么生成的。</p><p><code>createServerErrorConstructor</code> 返回 ServerError 类构造函数。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createServerErrorConstructor</span><span class="token punctuation">(</span><span class="token parameter">HttpError<span class="token punctuation">,</span> name<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> className <span class="token operator">=</span> <span class="token function">toClassName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">ServerError</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 Error 实例，错误描述为传入值或者</span>
    <span class="token keyword">var</span> msg <span class="token operator">=</span> message <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> message <span class="token operator">:</span> statuses<span class="token punctuation">[</span>code<span class="token punctuation">]</span>
    <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token comment">// 捕获构造点的堆栈跟踪，具体使用见 http://nodejs.cn/api/errors.html#errors_error_capturestacktrace_targetobject_constructoropt</span>
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ServerError<span class="token punctuation">)</span>

    <span class="token comment">// err.__proto__ = ServerError.prototype</span>
    <span class="token comment">// 即让 err 成为 ServerError 类实例</span>
    <span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token class-name">ServerError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>

    <span class="token comment">// 重定义 err 的错误描述</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> msg<span class="token punctuation">,</span>
      <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 重定义 err 的 name</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> className<span class="token punctuation">,</span>
      <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token comment">// ServerError 类继承自 HttpError 类</span>
  <span class="token function">inherits</span><span class="token punctuation">(</span>ServerError<span class="token punctuation">,</span> HttpError<span class="token punctuation">)</span>
  <span class="token comment">// 将构造函数重命名为 name + &#39;Error&#39;，避免重名</span>
  <span class="token function">nameFunc</span><span class="token punctuation">(</span>ServerError<span class="token punctuation">,</span> className<span class="token punctuation">)</span>

  <span class="token class-name">ServerError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>status <span class="token operator">=</span> code
  <span class="token class-name">ServerError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> code
  <span class="token class-name">ServerError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>expose <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token keyword">return</span> ServerError
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>createClientErrorConstructor</code> 返回 ClientError 类构造函数，其实现与 ServerError 基本一一致。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createClientErrorConstructor</span><span class="token punctuation">(</span><span class="token parameter">HttpError<span class="token punctuation">,</span> name<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> className <span class="token operator">=</span> <span class="token function">toClassName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">ClientError</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 Error 类实例</span>
    <span class="token keyword">var</span> msg <span class="token operator">=</span> message <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> message <span class="token operator">:</span> statuses<span class="token punctuation">[</span>code<span class="token punctuation">]</span>
    <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token comment">// 捕获构造点的堆栈跟踪，具体使用见 http://nodejs.cn/api/errors.html#errors_error_capturestacktrace_targetobject_constructoropt</span>
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ClientError<span class="token punctuation">)</span>

    <span class="token comment">// err.__proto__ = ClientError.prototype</span>
    <span class="token comment">// 即让 err 成为 ClientError 类实例</span>
    <span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token class-name">ClientError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>

    <span class="token comment">// 重定义 err 的错误描述</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> msg<span class="token punctuation">,</span>
      <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 重定义 err 的 name</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> className<span class="token punctuation">,</span>
      <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>
  <span class="token comment">// ClientError 类继承自 HttpError 类</span>
  <span class="token function">inherits</span><span class="token punctuation">(</span>ClientError<span class="token punctuation">,</span> HttpError<span class="token punctuation">)</span>
  <span class="token comment">// 将构造函数重命名为 name + &#39;Error&#39;，避免重名</span>
  <span class="token function">nameFunc</span><span class="token punctuation">(</span>ClientError<span class="token punctuation">,</span> className<span class="token punctuation">)</span>

  <span class="token class-name">ClientError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>status <span class="token operator">=</span> code
  <span class="token class-name">ClientError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> code
  <span class="token class-name">ClientError</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>expose <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token keyword">return</span> ClientError
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后来看 <code>createError()</code> 方法的实现，详细解释见注释：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 有两种调用方式，但是由于参数都是可省略的，所以需要考虑的参数情况比较多</span>
<span class="token comment">// createError([status], [message], [properties])</span>
<span class="token comment">// createError([status], [error], [properties])</span>
<span class="token keyword">function</span> <span class="token function">createError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> err
  <span class="token keyword">var</span> msg
  <span class="token keyword">var</span> status <span class="token operator">=</span> <span class="token number">500</span>
  <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 遍历参数，判断各个参数类型</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> arg <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">// 如果是继承自 Error，就是参数列表中对应的 error</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err <span class="token operator">=</span> arg
      status <span class="token operator">=</span> err<span class="token punctuation">.</span>status <span class="token operator">||</span> err<span class="token punctuation">.</span>statusCode <span class="token operator">||</span> status
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&#39;string&#39;</span><span class="token operator">:</span> <span class="token comment">// 参数列表中的 message</span>
        msg <span class="token operator">=</span> arg
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;number&#39;</span><span class="token operator">:</span> <span class="token comment">// 参数列表中的 status</span>
        status <span class="token operator">=</span> arg
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果 status 不是第一个参数，就报异常</span>
          <span class="token function">deprecate</span><span class="token punctuation">(</span>
            <span class="token string">&#39;non-first-argument status code; replace with createError(&#39;</span> <span class="token operator">+</span>
              arg <span class="token operator">+</span>
              <span class="token string">&#39;, ...)&#39;</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">&#39;object&#39;</span><span class="token operator">:</span> <span class="token comment">// 如果是 object，就是参数列表中的 properties</span>
        props <span class="token operator">=</span> arg
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 只支持处理 4xx 和 5xx 类型的异常状态</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> status <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>status <span class="token operator">&lt;</span> <span class="token number">400</span> <span class="token operator">||</span> status <span class="token operator">&gt;=</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token string">&#39;non-error status code; use only 4xx or 5xx status codes&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果 status 不满足条件，status 置为 500</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> status <span class="token operator">!==</span> <span class="token string">&#39;number&#39;</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>statuses<span class="token punctuation">[</span>status<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>status <span class="token operator">&lt;</span> <span class="token number">400</span> <span class="token operator">||</span> status <span class="token operator">&gt;=</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status <span class="token operator">=</span> <span class="token number">500</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取对应状态码的构造函数，已经挂载到 createError 上，没有就获取 400 或 500 对应的构造函数</span>
  <span class="token keyword">var</span> HttpError <span class="token operator">=</span> createError<span class="token punctuation">[</span>status<span class="token punctuation">]</span> <span class="token operator">||</span> createError<span class="token punctuation">[</span><span class="token function">codeClass</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 异常类实例创建</span>
    err <span class="token operator">=</span> HttpError <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">HttpError</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg <span class="token operator">||</span> statuses<span class="token punctuation">[</span>status<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">// // 捕获构造点的堆栈跟踪，具体使用见 http://nodejs.cn/api/errors.html#errors_error_capturestacktrace_targetobject_constructoropt</span>
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> createError<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>HttpError <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">HttpError</span><span class="token punctuation">)</span> <span class="token operator">||</span> err<span class="token punctuation">.</span>status <span class="token operator">!==</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err<span class="token punctuation">.</span>expose <span class="token operator">=</span> status <span class="token operator">&lt;</span> <span class="token number">500</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> err<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> status
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;status&#39;</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">!==</span> <span class="token string">&#39;statusCode&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="相关资料" tabindex="-1"><a class="header-anchor" href="#相关资料" aria-hidden="true">#</a> 相关资料</h2><p><a href="https://zhuanlan.zhihu.com/p/365787792" target="_blank" rel="noopener noreferrer">每天一个 npm 包：http-errors<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/jshttp/http-errors" target="_blank" rel="noopener noreferrer">http-errors 源码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/dougwilson/nodejs-depd" target="_blank" rel="noopener noreferrer">nodejs-depd 源码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/component/toidentifier" target="_blank" rel="noopener noreferrer">toidentifier 源码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/jshttp/statuses" target="_blank" rel="noopener noreferrer">statuses 源码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/isaacs/inherits" target="_blank" rel="noopener noreferrer">inherits 源码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/wesleytodd/setprototypeof" target="_blank" rel="noopener noreferrer">setprototypeof 源码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!--[--><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/yeahok/learn/npm/" class="router-link-active" aria-label="每天一个 npm 包"><!--[--><!--]--> 每天一个 npm 包 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/yeahok/assets/app-03679ccd.js" defer></script>
  </body>
</html>
